smoothing on topic distributions imaginary customers at the next as yet unused table smoothing on word distributions indexed < doc token > currently selected path ie leaf node through the ncrp n c r p tree initialize a single path initialize and fill the topic pointer arrays for every document set everything to the single path that we added earlier calculate p c_m | c_{ m} add weights for p w_m | c w_{ m} z the path may have no further customers and therefore be unavailable but it should still since we haven't reset documentleaves document leaves doc yet save the counts of every word at each level and remove counts from the current path calculate the weight for a new path at a given level skip the root if iteration > 1 { out newtopicweights new topic weights level } to avoid underflow we're using log weights and normalizing the node weights so that the largest weight is always 1 /*
			 if iteration > 1 {
			 if nodes i == documentleaves document leaves doc {
			 out print * 
			 }
			 out ncrpnode n c r p node nodes i level + \t + weights i + 
			 \t + nodeweights node weights get nodes i 
			 }
			*/ if iteration > 1 {system { out } if we have picked an internal node we need to add a new path first calculate the likelihood of the words at this level given this topic if iteration > 1 { out level + + nodeweight node weight } /*
				 if iteration > 1 {
				 out +eta + + + node typecounts type counts type + + + i + / + 
				 + etasum eta sum + + + node totaltokens total tokens + + + totaltokens total tokens + + 
				 + nodeweight node weight 
				 }
				*/ if iteration > 1 { out level + + nodeweight node weight } propagate that weight to the child nodes finally if this is an internal node add the weight of a new path calculating the ncrp n c r p prior proceeds from the root down ie following child links but adding the word topic weights comes from the bottom up following parent links and then child links it's possible that the leaf node may have been removed just prior to this round so the current node may not have an ncrp n c r p weight if so it's not going to be sampled anyway so ditch it get the leaf initialize level counts start with the leaf and build a describing the path for this doc the just tells we're not trying to add a and an out new node at level + level 